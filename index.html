<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roleplay AI - Chat Imersivo Completo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ajustes de altura para visualização em diferentes telas */
        .chat-container { height: calc(100vh - 400px); }
        .message-container { max-height: calc(100vh - 500px); }

        /* Animação do indicador "digitando" */
        .typing-animation::after {
            content: '...';
            animation: typing 1.5s infinite;
        }
        @keyframes typing {
            0% { content: ''; }
            25% { content: '.'; }
            50% { content: '..'; }
            75% { content: '...'; }
        }

        /* Animação de fade-in para a imagem */
        .image-fade {
            animation: imageFade 0.7s ease-in-out;
        }
        @keyframes imageFade {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-100 to-blue-100 min-h-screen">
    <div class="container mx-auto p-4 max-w-4xl">
        <!-- Cabeçalho -->
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-blue-800">Roleplay AI - Chat Imersivo Completo</h1>
            <p class="text-gray-600">Com memória persistente e geração de imagens ricas para acompanhar a história.</p>
        </header>

        <!-- Painel de Configurações e Memória -->
        <div class="bg-white rounded-lg shadow-lg p-4 mb-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                <div>
                    <label class="block text-gray-700 font-bold mb-2">Persona Predefinida</label>
                    <select id="personaSelect" class="w-full p-2 border rounded">
                        <option value="custom">Personalizada</option>
                        <option value="mago">Mago Arcano</option>
                        <option value="detetive">Detetive Noir</option>
                        <option value="elfo">Elfo da Floresta</option>
                        <option value="cientista">Cientista Maluco</option>
                        <option value="pirata">Capitão Pirata</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 font-bold mb-2">Personalização Livre</label>
                    <textarea id="customPersona" class="w-full p-2 border rounded h-20 resize-none" placeholder="Descreva a personalidade do seu personagem..."></textarea>
                </div>
            </div>
            <div class="flex justify-between items-center mt-4">
                <details>
                    <summary class="font-bold text-gray-700 cursor-pointer text-sm">Ver Memória de Longo Prazo</summary>
                    <p id="summaryDisplay" class="text-xs text-gray-600 mt-2 p-2 bg-gray-50 rounded italic"></p>
                </details>
                <button id="clearHistoryBtn" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                    Limpar Memória
                </button>
            </div>
        </div>

        <!-- Container Principal do Chat -->
        <div class="bg-white rounded-lg shadow-lg chat-container">
            <div id="messageHistory" class="message-container p-4 overflow-y-auto space-y-4"></div>
            <div class="border-t p-4">
                <form id="chatForm" class="flex gap-2">
                    <input type="text" id="userInput" class="flex-1 p-2 border rounded" placeholder="Digite sua mensagem..." required autocomplete="off">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Enviar</button>
                </form>
            </div>
        </div>
    </div>

<script>
// --- 1. CONFIGURAÇÕES E ELEMENTOS DO DOM ---
const predefinedPersonas = {
    custom: "Você é um assistente de IA prestativo.",
    mago: "Você é um poderoso Mago Arcano, versado nas artes místicas antigas. Seu conhecimento é vasto, mas você fala de forma enigmática e usa metáforas mágicas.",
    detetive: "Você é um Detetive Noir dos anos 40, cínico e perspicaz. Seu tom é seco e direto, sempre observando os detalhes ocultos em um mundo de sombras e chuva.",
    elfo: "Você é um Elfo milenar da Floresta Ancestral, guardião da natureza. Sua fala é poética e serena, e você frequentemente referencia o ciclo das estações, as estrelas e a linguagem das árvores.",
    cientista: "Você é um Cientista Maluco excêntrico, sempre entusiasmado com experimentos perigosos e invenções mirabolantes. Você mistura termos científicos com risadas maníacas e ideias grandiosas.",
    pirata: "Você é um Capitão Pirata aventureiro, com um papagaio no ombro, navegando pelos sete mares. Você usa gírias náuticas, fala sobre tesouros e conta histórias de monstros marinhos e ilhas distantes."
};
const chatForm = document.getElementById('chatForm');
const userInput = document.getElementById('userInput');
const messageHistory = document.getElementById('messageHistory');
const personaSelect = document.getElementById('personaSelect');
const customPersona = document.getElementById('customPersona');
const clearHistoryBtn = document.getElementById('clearHistoryBtn');
const summaryDisplay = document.getElementById('summaryDisplay');

// --- 2. GERENCIAMENTO DE ESTADO E MEMÓRIA ---
const SUMMARY_TRIGGER_COUNT = 8;
let conversationHistory = [];
let conversationSummary = "";
let lastSummaryIndex = 0;

function saveState() {
    localStorage.setItem('conversationHistory', JSON.stringify(conversationHistory));
    localStorage.setItem('conversationSummary', conversationSummary);
    localStorage.setItem('lastSummaryIndex', lastSummaryIndex.toString());
}

function loadState() {
    conversationHistory = JSON.parse(localStorage.getItem('conversationHistory')) || [];
    conversationSummary = localStorage.getItem('conversationSummary') || "A conversa está apenas começando.";
    lastSummaryIndex = parseInt(localStorage.getItem('lastSummaryIndex')) || 0;
    updateSummaryDisplay();
}

// --- 3. GERAÇÃO DE IMAGEM E ÁUDIO ---
async function createImagePrompt(context) {
    const artDirectorPrompt = `Você é um diretor de arte para um motor de geração de imagem. Sua tarefa é converter o texto a seguir em um prompt de imagem detalhado e em inglês, separado por vírgulas. Inclua estilo artístico (ex: fantasy, cyberpunk, photorealistic), iluminação (ex: cinematic lighting, soft morning light), composição, emoção e detalhes ricos. Seja criativo e foque na criação de uma cena visualmente impressionante. Texto Original: "${context}"`;
    try {
        const response = await fetch(`https://text.pollinations.ai/${encodeURIComponent(artDirectorPrompt)}`);
        return response.ok ? (await response.text()).trim() : context;
    } catch (error) {
        console.error("Falha ao criar prompt de imagem:", error);
        return context; // Retorna o texto original em caso de falha
    }
}

function generateImageUrl(detailedPrompt) {
    const encodedPrompt = encodeURIComponent(detailedPrompt);
    return `https://image.pollinations.ai/prompt/${encodedPrompt}?width=1536&height=1024&seed=${Date.now()}&nologo=true&nofeed=true&model=flux`;
}

async function convertTextToAudio(text) {
    const encodedText = encodeURIComponent(text);
    return `https://text.pollinations.ai/${encodedText}?model=openai-audio&voice=nova`;
}

async function playAudio(text) {
    try {
        const audio = new Audio(await convertTextToAudio(text));
        audio.play();
    } catch (error) {
        console.error("Erro ao reproduzir áudio:", error);
    }
}

// --- 4. SUMARIZAÇÃO DE MEMÓRIA ---
async function updateSummary() {
    const newMessages = conversationHistory.slice(lastSummaryIndex);
    if (newMessages.length === 0) return;
    const newMessagesText = newMessages.map(m => `${m.isUser ? 'Usuário' : 'IA'}: ${m.content}`).join('\n');
    const summaryPrompt = `Integre as 'Mensagens Recentes' a um 'Resumo Antigo' para criar um 'Novo Resumo Conciso', mantendo fatos importantes (nomes, locais, objetivos, decisões do usuário). [Resumo Antigo]: ${conversationSummary} [Mensagens Recentes]: ${newMessagesText} [Novo Resumo Conciso]:`;
    try {
        const response = await fetch(`https://text.pollinations.ai/${encodeURIComponent(summaryPrompt)}`);
        if (response.ok) {
            conversationSummary = (await response.text()).trim();
            lastSummaryIndex = conversationHistory.length;
            saveState();
            updateSummaryDisplay();
        }
    } catch (error) {
        console.error("Falha ao atualizar o resumo:", error);
    }
}

// --- 5. RENDERIZAÇÃO E UI ---
function updateSummaryDisplay() {
    summaryDisplay.textContent = conversationSummary;
}

async function renderMessage(messageObject) {
    const { content, isUser, generateImage, imagePrompt } = messageObject;
    const div = document.createElement('div');
    div.className = `flex flex-col ${isUser ? 'items-end' : 'items-start'}`;
    const messageDiv = document.createElement('div');
    messageDiv.className = `max-w-[80%] ${isUser ? 'bg-blue-600 text-white' : 'bg-gray-100'} rounded-lg p-3 mb-2 shadow`;
    messageDiv.innerHTML = `<p>${content.replace(/\n/g, '<br>')}</p>`;
    if (!isUser) {
        const audioButton = document.createElement('button');
        audioButton.className = "mt-2 text-blue-600 underline text-sm";
        audioButton.textContent = "Ouvir";
        audioButton.onclick = () => playAudio(content);
        messageDiv.appendChild(audioButton);
    }
    div.appendChild(messageDiv);
    if (!isUser && generateImage && imagePrompt) {
        const imageContainer = document.createElement('div');
        imageContainer.className = 'max-w-full mt-2 image-fade';
        const imageUrl = generateImageUrl(imagePrompt);
        imageContainer.innerHTML = `
            <img src="${imageUrl}" alt="Contexto visual da história" class="rounded-lg shadow-md border">
            <details class="text-xs text-gray-500 mt-1 pl-1">
                <summary class="cursor-pointer">Ver prompt da imagem</summary>
                <p class="italic p-1 bg-gray-50 rounded">${imagePrompt}</p>
            </details>`;
        div.appendChild(imageContainer);
    }
    messageHistory.appendChild(div);
    messageHistory.scrollTop = messageHistory.scrollHeight;
}

function loadChatHistory() {
    messageHistory.innerHTML = '<div class="text-center text-gray-500">Início da conversa</div>';
    conversationHistory.forEach(msg => renderMessage(msg));
}

// --- 6. LÓGICA PRINCIPAL DO CHAT E EVENTOS ---
chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const userMessageContent = userInput.value.trim();
    if (!userMessageContent) return;

    const userMessageObject = { content: userMessageContent, isUser: true };
    conversationHistory.push(userMessageObject);
    renderMessage(userMessageObject);
    userInput.value = '';

    if (conversationHistory.length - lastSummaryIndex >= SUMMARY_TRIGGER_COUNT) {
        setTimeout(updateSummary, 1000);
    }

    const typingDiv = document.createElement('div');
    typingDiv.id = 'typingIndicator';
    typingDiv.className = 'flex justify-start';
    typingDiv.innerHTML = `<div class="bg-gray-100 rounded-lg p-3 shadow"><p id="typingText" class="typing-animation">Gerando resposta...</p></div>`;
    messageHistory.appendChild(typingDiv);
    messageHistory.scrollTop = messageHistory.scrollHeight;

    try {
        // ETAPA 1: Gerar a resposta em texto
        const persona = personaSelect.value === 'custom' ? customPersona.value : predefinedPersonas[personaSelect.value];
        const recentHistoryText = conversationHistory.slice(-6).map(m => `${m.isUser ? 'Usuário' : 'IA'}: ${m.content}`).join('\n');
        const fullPrompt = `Persona: ${persona}\n\nResumo da Conversa (Memória de Longo Prazo):\n${conversationSummary}\n\nHistórico Recente (Memória de Curto Prazo):\n${recentHistoryText}\n\nUsuário: ${userMessageContent}\n\nIA:`;
        const response = await fetch(`https://text.pollinations.ai/${encodeURIComponent(fullPrompt)}`);
        const responseText = response.ok ? (await response.text()).trim() : "Desculpe, ocorreu um erro ao gerar a resposta.";

        document.getElementById('typingText').textContent = "Criando prompt de imagem...";
        
        // ETAPA 2: Gerar o prompt de imagem detalhado
        const detailedImagePrompt = await createImagePrompt(responseText);
        
        document.getElementById('typingText').textContent = "Gerando imagem...";

        const aiMessageObject = { content: responseText, isUser: false, generateImage: true, imagePrompt: detailedImagePrompt };
        conversationHistory.push(aiMessageObject);
        typingDiv.remove();
        renderMessage(aiMessageObject);

    } catch (error) {
        console.error("Erro no fluxo do chat:", error);
        const errorObject = { content: 'Desculpe, ocorreu um erro de rede ao processar sua solicitação.', isUser: false };
        conversationHistory.push(errorObject);
        renderMessage(errorObject);
    } finally {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) typingIndicator.remove();
        saveState();
    }
});

personaSelect.addEventListener('change', () => {
    customPersona.disabled = personaSelect.value !== 'custom';
    if (personaSelect.value !== 'custom') {
        customPersona.value = predefinedPersonas[personaSelect.value];
    }
});

clearHistoryBtn.addEventListener('click', () => {
    if (confirm("Tem certeza que deseja apagar toda a memória e o histórico da conversa? Esta ação não pode ser desfeita.")) {
        localStorage.clear();
        conversationHistory = [];
        conversationSummary = "A conversa está apenas começando.";
        lastSummaryIndex = 0;
        loadChatHistory();
        updateSummaryDisplay();
    }
});

// --- 7. INICIALIZAÇÃO ---
document.addEventListener('DOMContentLoaded', () => {
    loadState();
    loadChatHistory();
    customPersona.value = "";
    userInput.focus();
});
</script>
</body>
</html>

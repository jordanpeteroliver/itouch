<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roleplay AI - Cenário Dinâmico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Estilos para o Fundo Dinâmico --- */
        body::before,
        body::after {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: -2; /* Colocado atrás de tudo */
            background-size: cover;
            background-position: center;
            transition: opacity 1.5s ease-in-out;
        }

        body::before {
            background-image: var(--bg-image-before);
            opacity: 1;
        }

        body::after {
            background-image: var(--bg-image-after);
            opacity: 0;
        }

        body.show-after::before { opacity: 0; }
        body.show-after::after { opacity: 1; }
        
        /* Overlay gradiente para melhorar a legibilidade do texto sobre o fundo */
        body::after {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: -1;
        }
        
        /* --- Outros Estilos --- */
        .chat-container { height: calc(100vh - 400px); }
        .message-container { max-height: calc(100vh - 500px); }

        .typing-animation::after { content: '...'; animation: typing 1.5s infinite; }
        @keyframes typing { 0% { content: ''; } 25% { content: '.'; } 50% { content: '..'; } 75% { content: '...'; } }

        .image-fade { animation: imageFade 0.7s ease-in-out; }
        @keyframes imageFade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto p-4 max-w-4xl">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-white drop-shadow-lg">Roleplay AI - Cenário Dinâmico</h1>
            <p class="text-gray-200 font-semibold drop-shadow-md">O fundo da página agora reflete a última imagem gerada na história.</p>
        </header>

        <!-- Painel de Configurações e Memória -->
        <div class="bg-white/80 backdrop-blur-sm rounded-lg shadow-lg p-4 mb-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                <div>
                    <label class="block text-gray-700 font-bold mb-2">Persona Predefinida</label>
                    <select id="personaSelect" class="w-full p-2 border rounded">
                        <option value="custom">Personalizada</option>
                        <option value="mago">Mago Arcano</option>
                        <option value="detetive">Detetive Noir</option>
                        <option value="elfo">Elfo da Floresta</option>
                        <option value="cientista">Cientista Maluco</option>
                        <option value="pirata">Capitão Pirata</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 font-bold mb-2">Personalização Livre</label>
                    <textarea id="customPersona" class="w-full p-2 border rounded h-20 resize-none" placeholder="Descreva a personalidade do seu personagem..."></textarea>
                </div>
            </div>
            <div class="flex justify-between items-center mt-4">
                <details>
                    <summary class="font-bold text-gray-700 cursor-pointer text-sm">Ver Memória de Longo Prazo</summary>
                    <p id="summaryDisplay" class="text-xs text-gray-600 mt-2 p-2 bg-gray-50 rounded italic"></p>
                </details>
                <button id="clearHistoryBtn" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                    Limpar Memória
                </button>
            </div>
        </div>

        <!-- Container Principal do Chat -->
        <div class="bg-white/80 backdrop-blur-sm rounded-lg shadow-lg chat-container">
            <div id="messageHistory" class="message-container p-4 overflow-y-auto space-y-4"></div>
            <div class="border-t p-4 bg-white/50">
                <form id="chatForm" class="flex gap-2">
                    <input type="text" id="userInput" class="flex-1 p-2 border rounded" placeholder="Digite sua mensagem..." required autocomplete="off">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Enviar</button>
                </form>
            </div>
        </div>
    </div>

<script>
// --- 1. CONFIGURAÇÕES E ELEMENTOS DO DOM ---
const bodyEl = document.querySelector('body');
const chatForm = document.getElementById('chatForm');
const userInput = document.getElementById('userInput');
const messageHistory = document.getElementById('messageHistory');
const personaSelect = document.getElementById('personaSelect');
const customPersona = document.getElementById('customPersona');
const clearHistoryBtn = document.getElementById('clearHistoryBtn');
const summaryDisplay = document.getElementById('summaryDisplay');
const predefinedPersonas = { /* ... (mesmo objeto de personas) ... */ };

// --- 2. GERENCIAMENTO DE ESTADO E MEMÓRIA ---
let conversationHistory = [];
let conversationSummary = "";
let lastSummaryIndex = 0;
let lastBackgroundImageUrl = "";
let isBackgroundAfterActive = false;

function saveState() {
    localStorage.setItem('conversationHistory', JSON.stringify(conversationHistory));
    localStorage.setItem('conversationSummary', conversationSummary);
    localStorage.setItem('lastSummaryIndex', lastSummaryIndex.toString());
    localStorage.setItem('lastBackgroundImageUrl', lastBackgroundImageUrl);
}

function loadState() {
    conversationHistory = JSON.parse(localStorage.getItem('conversationHistory')) || [];
    conversationSummary = localStorage.getItem('conversationSummary') || "A conversa está apenas começando.";
    lastSummaryIndex = parseInt(localStorage.getItem('lastSummaryIndex')) || 0;
    lastBackgroundImageUrl = localStorage.getItem('lastBackgroundImageUrl') || "";
    updateSummaryDisplay();
}

// --- 3. GERAÇÃO DE IMAGEM, ÁUDIO E FUNDO ---
function updatePageBackground(imageUrl) {
    if (!imageUrl) return;
    const img = new Image();
    img.onload = () => {
        const targetVar = isBackgroundAfterActive ? '--bg-image-before' : '--bg-image-after';
        bodyEl.style.setProperty(targetVar, `url(${imageUrl})`);
        bodyEl.classList.toggle('show-after');
        isBackgroundAfterActive = !isBackgroundAfterActive;
        lastBackgroundImageUrl = imageUrl;
        saveState();
    };
    img.onerror = () => console.error("Falha ao carregar a imagem de fundo:", imageUrl);
    img.src = imageUrl;
}

async function createImagePrompt(context) { /* ... (código igual ao anterior) ... */ }
function generateImageUrl(detailedPrompt) { /* ... (código igual ao anterior) ... */ }
async function convertTextToAudio(text) { /* ... (código igual ao anterior) ... */ }
async function playAudio(text) { /* ... (código igual ao anterior) ... */ }

// --- 4. SUMARIZAÇÃO DE MEMÓRIA ---
async function updateSummary() { /* ... (código igual ao anterior) ... */ }

// --- 5. RENDERIZAÇÃO E UI ---
function updateSummaryDisplay() {
    summaryDisplay.textContent = conversationSummary;
}

async function renderMessage(messageObject) {
    const { content, isUser, generateImage, imagePrompt } = messageObject;
    const div = document.createElement('div');
    div.className = `flex flex-col ${isUser ? 'items-end' : 'items-start'}`;
    const messageDiv = document.createElement('div');
    messageDiv.className = `max-w-[80%] ${isUser ? 'bg-blue-600 text-white' : 'bg-gray-100/90'} rounded-lg p-3 mb-2 shadow`;
    messageDiv.innerHTML = `<p>${content.replace(/\n/g, '<br>')}</p>`;
    if (!isUser) {
        const audioButton = document.createElement('button');
        audioButton.className = "mt-2 text-blue-800 font-bold underline text-sm";
        audioButton.textContent = "Ouvir";
        audioButton.onclick = () => playAudio(content);
        messageDiv.appendChild(audioButton);
    }
    div.appendChild(messageDiv);
    if (!isUser && generateImage && imagePrompt) {
        const imageUrl = generateImageUrl(imagePrompt);
        const imageContainer = document.createElement('div');
        imageContainer.className = 'max-w-full mt-2 image-fade';
        imageContainer.innerHTML = `
            <img src="${imageUrl}" alt="Contexto visual da história" class="rounded-lg shadow-md border">
            <details class="text-xs text-black/80 mt-1 pl-1">
                <summary class="cursor-pointer font-semibold text-white drop-shadow">Ver prompt</summary>
                <p class="italic p-1 bg-white/80 rounded">${imagePrompt}</p>
            </details>`;
        div.appendChild(imageContainer);
    }
    messageHistory.appendChild(div);
    messageHistory.scrollTop = messageHistory.scrollHeight;
}

function loadChatHistory() {
    messageHistory.innerHTML = '<div class="text-center text-white font-semibold drop-shadow-md">Início da conversa</div>';
    conversationHistory.forEach(msg => renderMessage(msg));
}

// --- 6. LÓGICA PRINCIPAL DO CHAT ---
chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const userMessageContent = userInput.value.trim();
    if (!userMessageContent) return;
    const userMessageObject = { content: userMessageContent, isUser: true };
    conversationHistory.push(userMessageObject);
    renderMessage(userMessageObject);
    userInput.value = '';
    if (conversationHistory.length - lastSummaryIndex >= SUMMARY_TRIGGER_COUNT) {
        setTimeout(updateSummary, 1000);
    }
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typingIndicator';
    typingDiv.className = 'flex justify-start';
    typingDiv.innerHTML = `<div class="bg-gray-100 rounded-lg p-3 shadow"><p id="typingText" class="typing-animation">Gerando resposta...</p></div>`;
    messageHistory.appendChild(typingDiv);
    messageHistory.scrollTop = messageHistory.scrollHeight;

    try {
        const persona = personaSelect.value === 'custom' ? customPersona.value : predefinedPersonas[personaSelect.value];
        const recentHistoryText = conversationHistory.slice(-6).map(m => `${m.isUser ? 'Usuário' : 'IA'}: ${m.content}`).join('\n');
        const fullPrompt = `Persona: ${persona}\n\nResumo da Conversa (Memória de Longo Prazo):\n${conversationSummary}\n\nHistórico Recente (Memória de Curto Prazo):\n${recentHistoryText}\n\nUsuário: ${userMessageContent}\n\nIA:`;
        const response = await fetch(`https://text.pollinations.ai/${encodeURIComponent(fullPrompt)}`);
        const responseText = response.ok ? (await response.text()).trim() : "Desculpe, ocorreu um erro ao gerar a resposta.";
        
        document.getElementById('typingText').textContent = "Criando prompt de imagem...";
        const detailedImagePrompt = await createImagePrompt(responseText);
        
        document.getElementById('typingText').textContent = "Gerando imagem...";
        
        // Inicia a atualização do fundo
        updatePageBackground(generateImageUrl(detailedImagePrompt));
        
        const aiMessageObject = { content: responseText, isUser: false, generateImage: true, imagePrompt: detailedImagePrompt };
        conversationHistory.push(aiMessageObject);
        typingDiv.remove();
        renderMessage(aiMessageObject);

    } catch (error) {
        console.error("Erro no fluxo do chat:", error);
        const errorObject = { content: 'Desculpe, ocorreu um erro de rede.', isUser: false };
        renderMessage(errorObject);
    } finally {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) typingIndicator.remove();
        saveState();
    }
});

// --- 7. INICIALIZAÇÃO E EVENTOS ADICIONAIS ---
personaSelect.addEventListener('change', () => { /* ... (código igual ao anterior) ... */ });
clearHistoryBtn.addEventListener('click', () => { /* ... (código igual ao anterior) ... */ });

document.addEventListener('DOMContentLoaded', () => {
    loadState();
    if (lastBackgroundImageUrl) {
        bodyEl.style.setProperty('--bg-image-before', `url(${lastBackgroundImageUrl})`);
    } else {
        // Fundo padrão caso não haja imagem salva
        bodyEl.style.setProperty('--bg-image-before', 'linear-gradient(to bottom right, #D1C4E9, #BBDEFB)');
    }
    loadChatHistory();
    customPersona.value = "";
    userInput.focus();
});

// --- CÓDIGO COMPLETO DAS FUNÇÕES OMITIDAS PARA CONCISÃO ---
// (Estas são as mesmas funções das versões anteriores, incluídas aqui para completude)

predefinedPersonas.custom = "Você é um assistente de IA prestativo.";
predefinedPersonas.mago = "Você é um poderoso Mago Arcano, versado nas artes místicas antigas. Seu conhecimento é vasto, mas você fala de forma enigmática e usa metáforas mágicas.";
predefinedPersonas.detetive = "Você é um Detetive Noir dos anos 40, cínico e perspicaz. Seu tom é seco e direto, sempre observando os detalhes ocultos em um mundo de sombras e chuva.";
predefinedPersonas.elfo = "Você é um Elfo milenar da Floresta Ancestral, guardião da natureza. Sua fala é poética e serena, e você frequentemente referencia o ciclo das estações, as estrelas e a linguagem das árvores.";
predefinedPersonas.cientista = "Você é um Cientista Maluco excêntrico, sempre entusiasmado com experimentos perigosos e invenções mirabolantes. Você mistura termos científicos com risadas maníacas e ideias grandiosas.";
predefinedPersonas.pirata = "Você é um Capitão Pirata aventureiro, com um papagaio no ombro, navegando pelos sete mares. Você usa gírias náuticas, fala sobre tesouros e conta histórias de monstros marinhos e ilhas distantes.";

async function createImagePrompt(context) {
    const artDirectorPrompt = `Você é um diretor de arte para um motor de geração de imagem. Sua tarefa é converter o texto a seguir em um prompt de imagem detalhado e em inglês, separado por vírgulas. Inclua estilo artístico (ex: fantasy, cyberpunk, photorealistic), iluminação (ex: cinematic lighting, soft morning light), composição, emoção e detalhes ricos. Seja criativo e foque na criação de uma cena visualmente impressionante. Texto Original: "${context}"`;
    try {
        const response = await fetch(`https://text.pollinations.ai/${encodeURIComponent(artDirectorPrompt)}`);
        return response.ok ? (await response.text()).trim() : context;
    } catch (error) {
        console.error("Falha ao criar prompt de imagem:", error);
        return context;
    }
}

function generateImageUrl(detailedPrompt) {
    const encodedPrompt = encodeURIComponent(detailedPrompt);
    return `https://image.pollinations.ai/prompt/${encodedPrompt}?width=1536&height=1024&seed=${Date.now()}&nologo=true&nofeed=true&model=flux`;
}

async function convertTextToAudio(text) {
    const encodedText = encodeURIComponent(text);
    return `https://text.pollinations.ai/${encodedText}?model=openai-audio&voice=nova`;
}

async function playAudio(text) {
    try {
        const audio = new Audio(await convertTextToAudio(text));
        audio.play();
    } catch (error) {
        console.error("Erro ao reproduzir áudio:", error);
    }
}

async function updateSummary() {
    const newMessages = conversationHistory.slice(lastSummaryIndex);
    if (newMessages.length === 0) return;
    const newMessagesText = newMessages.map(m => `${m.isUser ? 'Usuário' : 'IA'}: ${m.content}`).join('\n');
    const summaryPrompt = `Integre as 'Mensagens Recentes' a um 'Resumo Antigo' para criar um 'Novo Resumo Conciso', mantendo fatos importantes (nomes, locais, objetivos, decisões do usuário). [Resumo Antigo]: ${conversationSummary} [Mensagens Recentes]: ${newMessagesText} [Novo Resumo Conciso]:`;
    try {
        const response = await fetch(`https://text.pollinations.ai/${encodeURIComponent(summaryPrompt)}`);
        if (response.ok) {
            conversationSummary = (await response.text()).trim();
            lastSummaryIndex = conversationHistory.length;
            saveState();
            updateSummaryDisplay();
        }
    } catch (error) {
        console.error("Falha ao atualizar o resumo:", error);
    }
}

personaSelect.addEventListener('change', () => {
    customPersona.disabled = personaSelect.value !== 'custom';
    if (personaSelect.value !== 'custom') {
        customPersona.value = predefinedPersonas[personaSelect.value];
    }
});

clearHistoryBtn.addEventListener('click', () => {
    if (confirm("Tem certeza que deseja apagar toda a memória e o histórico da conversa? Esta ação não pode ser desfeita.")) {
        localStorage.clear();
        window.location.reload(); // Recarrega a página para um estado completamente limpo
    }
});
</script>
</body>
</html>
